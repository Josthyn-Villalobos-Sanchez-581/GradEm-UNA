<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Inertia\Inertia;
use App\Models\Usuario;

class UsuariosConsultaController extends Controller
{
    public function index()
    {
        $usuario = Auth::user();

        // Obtener permisos del usuario autenticado
        $permisos = $usuario
            ? DB::table('roles_permisos')
                ->where('id_rol', $usuario->id_rol)
                ->pluck('id_permiso')
                ->toArray()
            : [];

        // Filtrar usuarios con rol "egresado" o "estudiante"
        $usuarios = Usuario::with(['rol', 'universidad', 'carrera'])
            ->whereHas('rol', function ($q) {
                $q->whereIn('nombre_rol', ['Estudiante/Egresado']); // coincide con tu tabla
            })
        ->get();

        return Inertia::render('Usuarios/PerfilesUsuarios', [
            'usuarios' => $usuarios,
            'userPermisos' => $permisos,
        ]);
    }
}
